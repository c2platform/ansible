#!/bin/bash
# {{ ansible_managed }}
# {{ vars[role + '_database_username'] }} Oracle Data Pump export script 

{% include './templates/_helpers.sh.j2' %}

{% include './templates/_env_oracle.sh.j2' %}


{% include './templates/_hooks_sh_confirm.sh.j2' %}

sids=$(sqlplus -s "{{ role|role_oracle_connect(vars) }}" << EOF
set pagesize 0 feedback off verify off heading off echo off;
select sid || ',' || serial# from v\$session where username = '{{ vars[role + '_database_username'] }}';
exit;
EOF
)

# Kill any {{ role }} Oracle sessions
for s in $sids; do
  yell "Killing Oracle session $s"

sqlplus -s "{{ role|role_oracle_connect(vars) }}" << EOF
set pagesize 0 feedback off verify off heading off echo off;
alter system kill session '$s' IMMEDIATE;
exit;
EOF
done

sqlplus -s "{{ role|role_oracle_connect(vars) }}" << EOF
drop user {{ vars[role + '_database_username'] }} cascade;
drop tablespace {{ vars[role + '_database_username'] }} including contents cascade constraints;
exit;
EOF
