#!/bin/bash
# {{ ansible_managed }}
# {{ vars[role + '_database_username'] }} Oracle Data Pump export script 

{% include './templates/_helpers.sh.j2' %}

{% include './templates/_env_oracle.sh.j2' %}


create=$(sqlplus -s "{{ role|role_oracle_connect(vars) }}" << EOF
whenever sqlerror exit sql.sqlcode;
create or replace directory {{ role|role_dump_dir_name(vars) }} as '{{ role|role_dump_dir_remote(vars) }}';
exit;
EOF
)

yell $create

dir=$(sqlplus -s "{{ role|role_oracle_connect(vars) }}" << EOF
set pagesize 0 feedback off verify off heading off echo off;
select directory_name from dba_directories where directory_name ='{{ role|role_dump_dir_name(vars) }}';
exit;
EOF
)

if [ "{{ role|role_dump_dir_name(vars) }}" != "$dir" ]
then
  die "Failed to create directory {{ role|role_dump_dir_name(vars) }} as {{ role|role_dump_dir_remote(vars) }}"
fi
scn=$(cat {{ role|role_scn_file(vars) }})
try expdp "{{ role|role_oracle_connect(vars) }}" flashback_scn=$scn {{ role|expdp_options(vars) }}

yell "Database dumped to {{ role|role_dump_dir(vars) }}"
