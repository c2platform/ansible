---
- name: jira-application.properties
  template:
    dest: "{{ jira_home_version_app }}/atlassian-jira/WEB-INF/classes/jira-application.properties"
    owner: "{{ jira_owner }}"
    group: "{{ jira_group }}"
    src: jira-application.properties.j2
  notify: jira-systemctl-restart

- name: Check dbconfig.xml exists
  stat:
    path: "{{ jira_home_version_home }}/dbconfig.xml"
  register: dbconfig_xml

- name: Jira setup check
  debug:
    msg: "Jira has not been setup yet. Use a browser to navigate to http://{{ jira_proxy_name }}:{{ jira_proxy_port }}{{ jira_web_context }}  and complete setup"
  changed_when: true
  when: not dbconfig_xml.stat.exists

- name: dbconfig.xml
  template:
    dest: "{{ jira_home_version_home }}/dbconfig.xml"
    owner: "{{ jira_owner }}"
    group: "{{ jira_group }}"
    src: dbconfig.xml.j2
  notify: jira-systemctl-restart
  when: dbconfig_xml.stat.exists 

- name: Enable MS Excel export
  template:
    dest: "{{ jira_home_version_home }}/jira-config.properties"
    owner: "{{ jira_owner }}"
    group: "{{ jira_group }}"
    src: jira-config.properties.j2
  notify: jira-systemctl-restart

- name: setenv.sh
  replace:
    path: "{{ jira_home_version_app }}/bin/setenv.sh"
    regexp: "{{ item.regexp }}"
    replace: "{{ item.replace }}"
  with_items:
    - regexp: "JVM_MINIMUM_MEMORY=\".*?\"" 
      replace: "JVM_MINIMUM_MEMORY=\"{{ jira_jvm_minimum_memory }}\""
    - regexp: "JVM_MAXIMUM_MEMORY=\".*?\"" 
      replace: "JVM_MAXIMUM_MEMORY=\"{{ jira_jvm_maximum_memory }}\""
    - regexp: "JVM_SUPPORT_RECOMMENDED_ARGS=\".*?\"" 
      replace: "JVM_SUPPORT_RECOMMENDED_ARGS=\"{{ jira_jvm_support_recommended_args }}\""
    - regexp: ".?JIRA_HOME=\".*?\"" 
      replace: "JIRA_HOME=\"{{ jira_home_version_home }}\""
  no_log: true
  notify: jira-systemctl-restart

- name: server.xml
  template:
    dest: "{{ jira_home_version_app }}/conf/server.xml"
    owner: "{{ jira_owner }}"
    group: "{{ jira_group }}"
    src: server.xml.j2
  notify: jira-systemctl-restart

- name: Extra libaries
  get_url:
    checksum: "{{ item.checksum }}"
    dest: "{{ jira_home_version_app }}/atlassian-jira/WEB-INF/lib/{{ item.url|basename }}"
    owner: "{{ jira_owner }}"
    group: "{{ jira_group }}"
    url: "{{ item.url }}"
  with_items: "{{ jira_libraries }}" 
  notify: jira-systemctl-restart
